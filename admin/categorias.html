<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bonamigo - Categor√≠as</title>
<link rel="stylesheet" href="../css/styles.css">
<link rel="stylesheet" href="../css/admin.css">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="../img/logo_bonamigo.png">
</head>
<body class="admin-body">
<div class="admin-container">
  <!-- Overlay para m√≥viles -->
  <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
  
  <aside class="admin-sidebar" id="admin-sidebar">
    <div class="sidebar-header">
      <img src="../img/logo.png" alt="Bonamigo" class="sidebar-logo">
      <h2 id="sidebar-user-name">Cargando...</h2>
    </div>
    <nav class="sidebar-nav">
      <a href="dashboard.html" class="nav-item"><span class="nav-icon">üìä</span><span>Dashboard</span></a>
      <a href="productos.html" class="nav-item"><span class="nav-icon">üì¶</span><span>Productos</span></a>
      <a href="categorias.html" class="nav-item active"><span class="nav-icon">üè∑Ô∏è</span><span>Categor√≠as</span></a>
      <a href="ventas.html" class="nav-item"><span class="nav-icon">üí∞</span><span>Ventas</span></a>
      <a href="compras.html" class="nav-item"><span class="nav-icon">üõí</span><span>Compras</span></a>
      <a href="estadisticas.html" class="nav-item"><span class="nav-icon">üìà</span><span>Estad√≠sticas</span></a>
    </nav>
    <div class="sidebar-footer">
      <button id="logout-btn" class="btn-logout">Cerrar Sesi√≥n</button>
      <a href="../index.html" class="link-site">‚Üê Ver sitio</a>
    </div>
  </aside>
  
  <main class="admin-main">
    <header class="admin-header">
      <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
      <h1>Categor√≠as</h1>
      <div class="header-user">
        <span id="user-name">Admin</span>
      </div>
    </header>
    
    <div class="admin-content">
      <div class="table-container">
        <div class="table-header">
          <h2>Lista de Categor√≠as</h2>
          <button class="btn-primary" onclick="abrirModalCategoria()">+ Nueva Categor√≠a</button>
        </div>
        
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Descripci√≥n</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="categorias-table">
            <tr><td colspan="4" style="text-align: center; padding: 40px;">Cargando...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>
</div>

<!-- Modal Categor√≠a -->
<div class="modal-overlay" id="modal-categoria">
  <div class="modal-box">
    <button class="modal-close" onclick="cerrarModalCategoria()">&times;</button>
    <h2 id="modal-categoria-titulo">Nueva Categor√≠a</h2>
    
    <form id="form-categoria">
      <input type="hidden" id="categoria-id">
      
      <div class="form-group">
        <label for="categoria-nombre">Nombre *</label>
        <input type="text" id="categoria-nombre" required>
      </div>
      
      <div class="form-group">
        <label for="categoria-descripcion">Descripci√≥n</label>
        <textarea id="categoria-descripcion"></textarea>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button type="submit" class="btn-primary">Guardar</button>
        <button type="button" class="btn-secondary" onclick="cerrarModalCategoria()">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<script src="../js/config.js"></script>
<script>
// Funci√≥n helper para API
const apiFetch = window.apiRequest || fetch;

// Verificar autenticaci√≥n - siempre pedir login
apiFetch('/api/session')
  .then(res => res.json())
  .then(data => {
    if (!data.authenticated) {
      apiFetch('/api/logout', { method: 'POST' }).finally(() => {
        window.location.href = 'login.html';
      });
    } else {
      document.getElementById('user-name').textContent = data.usuario;
      const sidebarUserName = document.getElementById('sidebar-user-name');
      if (sidebarUserName) {
        sidebarUserName.textContent = data.usuario;
      }
      cargarCategorias();
    }
  })
  .catch(() => {
    window.location.href = 'login.html';
  });

// Logout
document.getElementById('logout-btn').addEventListener('click', async () => {
  await apiFetch('/api/logout', { method: 'POST' });
  window.location.href = 'login.html';
});

// Cargar categor√≠as
async function cargarCategorias() {
  try {
    const response = await apiFetch('/api/categorias');
    const categorias = await response.json();
    const tbody = document.getElementById('categorias-table');
    
    if (categorias.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px;">No hay categor√≠as</td></tr>';
      return;
    }
    
    tbody.innerHTML = categorias.map(c => `
      <tr>
        <td>${c.id}</td>
        <td>${c.nombre}</td>
        <td>${c.descripcion || '-'}</td>
        <td>
          <button class="btn-secondary" onclick="editarCategoria(${c.id})">Editar</button>
          <button class="btn-danger" onclick="eliminarCategoria(${c.id})">Eliminar</button>
        </td>
      </tr>
    `).join('');
  } catch (error) {
    console.error('Error al cargar categor√≠as:', error);
  }
}

// Abrir modal
function abrirModalCategoria() {
  document.getElementById('modal-categoria-titulo').textContent = 'Nueva Categor√≠a';
  document.getElementById('form-categoria').reset();
  document.getElementById('categoria-id').value = '';
  document.getElementById('modal-categoria').classList.add('show');
}

// Cerrar modal
function cerrarModalCategoria() {
  document.getElementById('modal-categoria').classList.remove('show');
}

// Editar categor√≠a
async function editarCategoria(id) {
  try {
    const response = await apiFetch('/api/categorias');
    const categorias = await response.json();
    const categoria = categorias.find(c => c.id === id);
    
    if (!categoria) {
      alert('Categor√≠a no encontrada');
      return;
    }
    
    document.getElementById('modal-categoria-titulo').textContent = 'Editar Categor√≠a';
    document.getElementById('categoria-id').value = categoria.id;
    document.getElementById('categoria-nombre').value = categoria.nombre;
    document.getElementById('categoria-descripcion').value = categoria.descripcion || '';
    document.getElementById('modal-categoria').classList.add('show');
  } catch (error) {
    alert('Error al cargar categor√≠a: ' + error.message);
  }
}

// Eliminar categor√≠a
async function eliminarCategoria(id) {
  if (!confirm('¬øEst√°s seguro de eliminar esta categor√≠a?')) return;
  
  try {
    const response = await apiFetch(`/api/categorias/${id}`, { method: 'DELETE' });
    const data = await response.json();
    
    if (response.ok) {
      alert('Categor√≠a eliminada exitosamente');
      cargarCategorias();
    } else {
      alert('Error: ' + data.error);
    }
  } catch (error) {
    alert('Error al eliminar categor√≠a: ' + error.message);
  }
}

// Guardar categor√≠a
document.getElementById('form-categoria').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const id = document.getElementById('categoria-id').value;
  const data = {
    nombre: document.getElementById('categoria-nombre').value,
    descripcion: document.getElementById('categoria-descripcion').value
  };
  
  try {
    const url = id ? `/api/categorias/${id}` : '/api/categorias';
    const method = id ? 'PUT' : 'POST';
    
    const response = await apiFetch(url, {
      method: method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await response.json();
    
    if (response.ok) {
      alert('Categor√≠a guardada exitosamente');
      cerrarModalCategoria();
      cargarCategorias();
    } else {
      alert('Error: ' + result.error);
    }
  } catch (error) {
    alert('Error al guardar categor√≠a: ' + error.message);
  }
});

// Toggle sidebar en m√≥viles
function toggleSidebar() {
  const sidebar = document.getElementById('admin-sidebar');
  const overlay = document.getElementById('sidebar-overlay');
  sidebar.classList.toggle('show');
  overlay.classList.toggle('show');
}
</script>
</body>
</html>


